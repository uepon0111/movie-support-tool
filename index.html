<!-- head 部分に追加 -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>

<script>
  // ※ 下をあなたの値に置き換える（ここには実際のキーは貼らないでください）
  const CLIENT_ID = 'あなたの_OAuth_Web_client_id.apps.googleusercontent.com';
  const API_KEY = 'あなたの_API_KEY';
  const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

  // トークン用クライアント（Google Identity Services）
  let tokenClient = null;
  let oauthToken = null;
  let gapiLoaded = false;

  // gapiロード検知
  function onGapiLoad() {
    gapiLoaded = true;
    gapi.load('picker', {'callback': () => { console.log('picker lib loaded'); }});
  }
  window.onGapiLoad = onGapiLoad;
  // gsi の token client 初期化
  function initTokenClient() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        if (tokenResponse && tokenResponse.access_token) {
          oauthToken = tokenResponse.access_token;
          createPicker(); // トークン取得成功したら呼ぶ
        } else {
          console.warn('tokenResponse', tokenResponse);
          alert('トークン取得に失敗しました');
        }
      },
    });
  }

  // Picker を生成して表示
  function createPicker(){
    if (!gapiLoaded || !oauthToken) { console.warn('gapi or token missing'); return; }
    const view = new google.picker.DocsView(google.picker.ViewId.DOCS)
      .setIncludeFolders(true)
      .setMimeTypes('video/*')
      .setSelectFolderEnabled(true);

    const picker = new google.picker.PickerBuilder()
      .enableFeature(google.picker.Feature.NAV_HIDDEN)
      .enableFeature(google.picker.Feature.MULTISELECT_ENABLED)
      .setAppId(undefined) // App ID not required for client-side usage
      .setDeveloperKey(API_KEY)
      .setOAuthToken(oauthToken)
      .addView(view)
      .setCallback(pickerCallback)
      .build();

    picker.setVisible(true);
  }

  function pickerCallback(data) {
    if (data.action === google.picker.Action.PICKED) {
      // 選択ファイルの配列を扱う（複数選択）
      const docs = data.docs || [];
      // docs に含まれるアイテムの情報を使って Drive API でダウンロードする等を行う
      console.log('Picked docs:', docs);
      // 例: docs[0].id を使ってファイルを取得するなど
      // ここでは単純に選択を履歴に保存する流れに繋げてください
      alert(docs.length + ' 個選択されました。コンソールを確認してください。');
    } else if (data.action === google.picker.Action.CANCEL) {
      console.log('Picker cancelled');
    } else {
      console.log('Picker event', data);
    }
  }

  // pickBtn のクリックハンドラ（トークン取得＋Picker起動）
  document.addEventListener('DOMContentLoaded', () => {
    // gapi を読み込んだら onGapiLoad が呼ばれる (上の関数)
    // google.accounts.gsi は gsi client のロード後に使える
    const pickBtn = document.getElementById('pickBtn');
    pickBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      // 初回: tokenClient 初期化
      if (!tokenClient) {
        initTokenClient();
      }
      // 要求：ユーザー操作に連動して token を要求（ポップアップが出ます）
      tokenClient.requestAccessToken({prompt: 'consent'});
      // トークンが戻った callback 内で createPicker() が呼ばれます
    });
  });
</script>
